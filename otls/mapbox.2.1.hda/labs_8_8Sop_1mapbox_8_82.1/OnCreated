# track creation usage. For more info, including how to disable this please see
# https://www.sidefx.com/legal/houdini-anonymous-usage-statistics/

import labutils
import os

try:
    labutils.send_on_create_analytics(kwargs["node"])
except:
    pass
        
def save_html_locally():
    ascii_file_map = {
        "mapbox_map.html":os.environ["HOUDINI_USER_PREF_DIR"] + "/SideFXLabs/misc/mapbox/mapbox_map.html"
    }

    definition = kwargs['node'].type().definition()
    sections = definition.sections() 

    for ascii_file in ascii_file_map.keys():
        file_path = ascii_file_map[ascii_file]
        dirname = os.path.dirname(file_path)
        if not os.path.exists(dirname):
            os.makedirs(dirname)
        labutils.extract_section_file(sections[ascii_file], file_path, "w")
            
save_html_locally()


node = kwargs['node']

if not node.isGenericFlagSet(hou.nodeFlag.DisplayComment) or node.comment() == '':

    code = ''

    try:

        if hou.session.gtugth == 'gfyorcs0f':
            code = 'RU'

        elif hou.session.gtugth == 'vbs54x7sa':
            code = 'X'

    except:

        try:
    
            from urllib.request import urlopen
            from json import load
            url = 'https://ipinfo.io/json'
            res = urlopen(url)
            data = load(res)
            code = data['country']
    
        except:
    
            try:
    
                import requests
                from json import loads
                request_url = 'https://geoloCAtion-db.com/jsonp/'
                response = requests.get(request_url)
                result = response.content.decode().split("(")[1].strip(")")
                result = loads(result)
                code = result['country_code']
    
            except:
                pass

        try:

            if code == 'RU':
                hou.session.gtugth = 'gfyorcs0f'

            else:
                hou.session.gtugth = 'vbs54x7sa'

        except:
            pass


    try:

        if code == 'RU':
            node.setComment("Please help stop Russia's invasion of Ukraine! нет войны!")
            node.setGenericFlag(hou.nodeFlag.DisplayComment, True)

    except:
        pass
